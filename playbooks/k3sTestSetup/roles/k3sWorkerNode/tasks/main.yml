---
# This role installs K3s as an agent (worker) node.
- name: Install the k3s-selinux package
  ansible.builtin.dnf:
    name: k3s-selinux
    state: present
    update_cache: true
  when:
    - ansible_facts['os_family'] == "RedHat"

- name: Download k3s binary
  ansible.builtin.get_url:
    url: "https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s"
    dest: /usr/local/bin/k3s
    mode: '0755'
    owner: root
    group: root
  when: not (ansible_check_mode is defined and ansible_check_mode)

- name: Create K3s config directory
  ansible.builtin.file:
    path: /etc/rancher/k3s
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Install K3s agent using the binary and environment variables (mimicking the script's core action)
  ansible.builtin.command:
    cmd: /usr/local/bin/k3s agent
    creates: /etc/systemd/system/k3s-agent.service
  environment:
    K3S_URL: "{{ k3s_server_url }}"
    K3S_TOKEN: "{{ k3s_token }}"
  # The 'creates' ensures this only runs on a fresh install, like the script would.
  # This command generates the agent service file, fetches dependencies, and starts k3s-agent.

- name: Enable and Start K3s Agent Service
  systemd:
    name: k3s-agent
    state: started
    enabled: yes
    daemon_reload: yes